name: Deploy Frontend

on:
  push:
    branches: [ main ]
    paths:
      - 'ecom-dashboard/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub (optional)
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      # Uncomment if you want to push to Docker Hub
      # if: secrets.DOCKER_USERNAME != ''
      
    - name: Build and deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ vars.SERVER_HOST }}
        username: ${{ vars.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ vars.SERVER_PORT }}
        script: |
          # Naviguer vers le rÃ©pertoire du frontend
          cd /root/ecom/ecom-dashboard
          
          # ArrÃªter le conteneur existant
          echo "ArrÃªt du conteneur existant..."
          docker stop ecom-dashboard || true
          docker rm ecom-dashboard || true
          
          # Supprimer l'ancienne image
          echo "Suppression de l'ancienne image..."
          docker rmi ecom-dashboard:latest || true
          
          # Mettre Ã  jour le code
          echo "Mise Ã  jour du code..."
          git pull origin main
          
          # Reconstruire l'image
          echo "Construction de la nouvelle image..."
          docker build --target production -t ecom-dashboard:latest .
          
          # DÃ©marrer le conteneur
          echo "DÃ©marrage du conteneur..."
          docker run -d \
            --name ecom-dashboard \
            -p 80:80 \
            --restart unless-stopped \
            ecom-dashboard:latest
          
          # Attendre que le service soit prÃªt
          echo "Attente du dÃ©marrage du service..."
          sleep 30
          
          # VÃ©rifier le statut
          echo "VÃ©rification du statut..."
          if curl -f http://localhost > /dev/null 2>&1; then
            echo "âœ… DÃ©ploiement rÃ©ussi - Frontend accessible sur http://localhost"
          else
            echo "âŒ Erreur - Frontend non accessible"
            docker logs ecom-dashboard
            exit 1
          fi
          
          # Nettoyer les images non utilisÃ©es
          echo "Nettoyage des images non utilisÃ©es..."
          docker image prune -f
          
          echo "ğŸ‰ DÃ©ploiement du frontend terminÃ© avec succÃ¨s!" 